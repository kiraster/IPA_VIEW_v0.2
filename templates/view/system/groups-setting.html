<!doctype html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8" />
  <title>分组修改</title>
  <meta name="renderer" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  </style>
</head>

<body class="pear-container">
  <div class="layui-row layui-col-space10">
    <div class="layui-col-md12">
      <div class="layui-card">
        <div class="layui-card-body">
          <form class="layui-form" action="">
            <div class="layui-form-item">
              <label class="layui-form-label">分组名称</label>
              <div class="layui-input-inline">
                <input type="text" id="groupSearchInput" placeholder="搜索分组名称…" class="layui-input">
              </div>
              <button type="submit" class="layui-btn layui-btn-primary layui-border" lay-submit
                lay-filter="group-query">
                <i class="layui-icon layui-icon-search"></i>
                查询
              </button>
              <button type="reset" class="layui-btn layui-btn-primary layui-border" id="setting-group-table-reload">
                <i class="layui-icon layui-icon-refresh"></i>
                重置
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="layui-row layui-col-space10">
      <div class="layui-col-md6">
        <div class="layui-card">
          <div class="layui-card-body">
            <table id="setting-group-table" lay-filter="setting-group-table"></table>
          </div>
        </div>
      </div>
      <div class="layui-col-md6">
        <div class="layui-card">
          <div class="layui-card-body">
            <svg class="setting-empty" style="margin-top: 50px; margin-left: 220px; margin-bottom: 80px;" width="284"
              height="252" viewBox="0 0 184 152" xmlns="http://www.w3.org/2000/svg">
              <g fill="none" fillRule="evenodd">
                <g transform="translate(24 31.67)">
                  <ellipse fillOpacity=".8" fill="#F5F5F7" cx="67.797" cy="106.89" rx="67.797" ry="12.668"></ellipse>
                  <path
                    d="M122.034 69.674L98.109 40.229c-1.148-1.386-2.826-2.225-4.593-2.225h-51.44c-1.766 0-3.444.839-4.592 2.225L13.56 69.674v15.383h108.475V69.674z"
                    fill="#AEB8C2"></path>
                  <path
                    d="M101.537 86.214L80.63 61.102c-1.001-1.207-2.507-1.867-4.048-1.867H31.724c-1.54 0-3.047.66-4.048 1.867L6.769 86.214v13.792h94.768V86.214z"
                    fill="url(#linearGradient-1)" transform="translate(13.56)"></path>
                  <path d="M33.83 0h67.933a4 4 0 0 1 4 4v93.344a4 4 0 0 1-4 4H33.83a4 4 0 0 1-4-4V4a4 4 0 0 1 4-4z"
                    fill="#F5F5F7"></path>
                  <path
                    d="M42.678 9.953h50.237a2 2 0 0 1 2 2V36.91a2 2 0 0 1-2 2H42.678a2 2 0 0 1-2-2V11.953a2 2 0 0 1 2-2zM42.94 49.767h49.713a2.262 2.262 0 1 1 0 4.524H42.94a2.262 2.262 0 0 1 0-4.524zM42.94 61.53h49.713a2.262 2.262 0 1 1 0 4.525H42.94a2.262 2.262 0 0 1 0-4.525zM121.813 105.032c-.775 3.071-3.497 5.36-6.735 5.36H20.515c-3.238 0-5.96-2.29-6.734-5.36a7.309 7.309 0 0 1-.222-1.79V69.675h26.318c2.907 0 5.25 2.448 5.25 5.42v.04c0 2.971 2.37 5.37 5.277 5.37h34.785c2.907 0 5.277-2.421 5.277-5.393V75.1c0-2.972 2.343-5.426 5.25-5.426h26.318v33.569c0 .617-.077 1.216-.221 1.789z"
                    fill="#DCE0E6"></path>
                </g>
                <path
                  d="M149.121 33.292l-6.83 2.65a1 1 0 0 1-1.317-1.23l1.937-6.207c-2.589-2.944-4.109-6.534-4.109-10.408C138.802 8.102 148.92 0 161.402 0 173.881 0 184 8.102 184 18.097c0 9.995-10.118 18.097-22.599 18.097-4.528 0-8.744-1.066-12.28-2.902z"
                  fill="#DCE0E6"></path>
                <g transform="translate(149.65 15.383)" fill="#FFF">
                  <ellipse cx="20.654" cy="3.167" rx="2.849" ry="2.815"></ellipse>
                  <path d="M5.698 5.63H0L2.898.704zM9.259.704h4.985V5.63H9.259z"></path>
                </g>
              </g>
            </svg>
            <!-- <table id="dict-data-table" lay-filter="dict-data-table"></table> -->
            <div id="ID-transfer-demo-value"></div>
            <div id="group-transfer"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 添加数据行表单 -->
  <form class="layui-form" lay-filter="add-setting-group-table-form" id="add-setting-group-table-form" action=""
    style="padding: 5px; display: none">
    <br>
    <div class="layui-form-item">
      <label class="layui-form-label">分组名称</label>
      <div class="layui-input-inline layui-input-wrap">
        <input type="text" name="group_name" placeholder="输入分组" lay-verify="required" autocomplete="off"
          lay-affix="clear" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item">
      <div class="layui-input-block">
        <button type="submit" class="layui-btn" lay-submit lay-filter="add-setting-group-table-form-btn">
          立即提交
        </button>
        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
      </div>
    </div>
  </form>
  <!-- 更新数据行表单 -->
  <form class="layui-form" lay-filter="edit-setting-group-table-form" id="edit-setting-group-table-form" action=""
    style="padding: 5px; display: none">
    <div class="layui-form-item" style="display: none;">
      <label class="layui-form-label">ID</label>
      <div class="layui-input-inline layui-input-wrap">
        <input type="text" name="id" placeholder="输入分组" lay-verify="required" disabled autocomplete="off"
          class="layui-input">
      </div>
    </div>
    <br>
    <div class="layui-form-item">
      <label class="layui-form-label">分组名称</label>
      <div class="layui-input-inline layui-input-wrap">
        <input type="text" name="group_name" placeholder="输入分组" lay-verify="required" autocomplete="off"
          lay-affix="clear" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item">
      <div class="layui-input-block">
        <button type="submit" class="layui-btn" lay-submit lay-filter="edit-setting-group-table-form-btn">
          立即提交
        </button>
        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
      </div>
    </div>
  </form>
</body>
<!-- 穿梭框按钮渲染 -->
<script type="text/html" id="setting-group-table-bar">
  <button class="layui-btn layui-btn-primary layui-btn-sm" lay-event="details">
    <i class="layui-icon layui-icon-transfer"></i>
  </button>
</script>
<script>
  layui.use(function () {
    let table = layui.table
    let form = layui.form
    let $ = layui.jquery
    let popup = layui.popup
    let transfer = layui.transfer

    // 表格渲染
    table.render({
      elem: "#setting-group-table",
      id: "setting-group-table",
      url: "/api/v1/groups/setting",
      // height: "full-35", // 注释表示采用默认值，自适应
      // toolbar: "#setting-group-table-toolbar", // 自定义toolbar
      toolbar: 'default',
      // toolbar: true, // 仅开启工具栏右侧，不显示左侧模板
      // page: true,
      page: {
        limit: 20, //每页显示20行数据
      },
      cols: [
        [
          { type: 'checkbox', fixed: 'left' },  //开启复选框
          { field: "id", title: "ID", sort: true, minWidth: 80, maxWidth: 120, align: 'center' }, // , fixed: "left" 横向滚动冻结列
          { field: "group_name", title: "分组名称", sort: true, align: 'center', width: '50%' }, // , fixed: "left" 横向滚动冻结列
          { title: '操作', toolbar: '#setting-group-table-bar', align: 'center' }
        ],
      ],
    });

    // 查询
    form.on('submit(group-query)', function (data) {

      // 获取输入框的值
      var searchValue = $('#groupSearchInput').val();

      if (!searchValue) {
        // 弹出提示框
        layer.msg('没有输入搜索关键字', { icon: 0, time: 2000 });
        // 阻止表单默认提交行为
        return false;
      } else {
        // 发送请求，重载表格
        table.reloadData('setting-group-table', {
          // 指定搜索api接口
          url: '/api/v1/groups/search',
          // 传递过滤条件和搜索值
          where: { value: searchValue }
        });
        // 阻止表单默认提交行为
        return false;
      }
    });

    // 重置表格-绑定重置按钮
    $('#setting-group-table-reload').on('click', function () {
      table.reloadData('setting-group-table', {
        url: "/api/v1/groups/setting",
      });
    });

    // 头部工具栏事件
    table.on('toolbar(setting-group-table)', function (obj) {
      var options = obj.config; // 获取当前表格属性配置项
      var checkStatus = table.checkStatus(options.id); // 获取选中行相关数据
      var selectedData = checkStatus.data; // 获取选中行的数据数组
      var row_length = selectedData.length; // 选中行数量，可作为是否有选中行的条件

      // 根据不同的事件名进行相应的操作
      switch (obj.event) { // 对应模板元素中的 lay-event 属性值
        case 'add':
          // 关闭对话框
          layer.close();
          layer.open({
            title: '添加行',
            type: 1,
            shade: false,
            content: $("#add-setting-group-table-form"),
            area: ["350px", "200px"], //弹出层尺寸
          });
          form.render($("#add-setting-group-table-form"));

          break;
        case 'delete':
          // 判断是否选中行，然后执行删除操作
          if (row_length > 0) {
            // 弹出确认对话框
            layer.confirm('确定要删除吗？', {
              title: '删除确认',
              // btn: ['确定', '取消'], // 按钮
              icon: 3 // 询问图标
            }, function () {
              // 确定按钮的回调函数
              // 关闭对话框
              // layer.close();
              // 提取 ID 并准备数据
              var idsToDelete = selectedData.map(function (row) {
                return row.id;
              });

              // 判断列表中是否包含整数值1,前后端都做判断
              if (idsToDelete.includes(1)) {
                layer.msg('不能删除ID为1的默认组!');
                return;
              }
              var loadIndex = layer.load(0);

              // 执行删除操作，发起 AJAX 请求
              $.ajax({
                url: `/api/v1/groups`,
                type: "DELETE",
                contentType: "application/json",
                // headers: {
                //   "X-CSRF-TOKEN": getCookie("csrf_access_token"),
                // },
                data: JSON.stringify({ ids: idsToDelete }),
                success: function (response) {
                  if (response.success) {
                    layer.msg(response.message, { icon: 1 });
                    table.reloadData('setting-group-table');
                  } else {
                    layer.msg(response.message, { icon: 2 });
                  }
                },
                error: function (xhr, status, error) {
                  var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '请求失败';
                  layer.msg('错误: ' + errorMessage, { icon: 2 });
                }
              });
              setTimeout(function () {
                layer.close(loadIndex); // 关闭加载弹层
              }, 3000);
            }, function () {
              // 关闭对话框
              layer.close();
            });
          } else {
            layer.msg('没有选中行');
          }
          break;
        case 'update':
          // layer.msg('编辑');
          if (row_length === 1) {
            // // 关闭对话框
            // layer.close();
            var data_row = selectedData[0];
            form.val("edit-setting-group-table-form", {
              "id": data_row.id,
              "group_name": data_row.group_name,
            });
            layer.open({
              title: '编辑行   ID: ' + data_row.id + '    ' + '分组名称: ' + data_row.group_name,
              type: 1,
              shade: false,
              content: $("#edit-setting-group-table-form"),
              area: ["350px", "200px"], //弹出层尺寸
            });
            form.render($("#edit-setting-group-table-form"));
          } else if (row_length > 1) {
            layer.msg('选中行数大于1');
          } else {
            layer.msg('没有选中行');
          }
          break;
      };
    });

    // 提交新增信息
    form.on("submit(add-setting-group-table-form-btn)", function (data) {
      var field = data.field;
      var loadIndex = layer.load(0);
      $.ajax({
        url: '/api/v1/groups',
        type: 'POST',
        contentType: "application/json",
        // headers: {
        //   "X-CSRF-TOKEN": getCookie("csrf_access_token"),
        // },
        data: JSON.stringify(field),
        success: function (response) {
          if (response.success) {
            layer.closeAll();
            table.reloadData('setting-group-table');
            layer.msg(response.message, { icon: 1 });
            $('#add-setting-group-table-form')[0].reset();
          } else {
            layer.msg(response.message, { icon: 2 });
          }
        },
        error: function (xhr, status, error) {
          var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '请求失败';
          layer.msg('错误: ' + errorMessage, { icon: 2 });
        }
      });
      setTimeout(function () {
        layer.close(loadIndex); // 关闭加载弹层
      }, 3000);
      return false;
    });

    // 提交修改信息
    form.on("submit(edit-setting-group-table-form-btn)", function (data) {
      var field = data.field;
      var loadIndex = layer.load(0);
      $.ajax({
        url: '/api/v1/groups/' + field.id,
        type: 'PATCH',
        contentType: "application/json",
        // headers: {
        //   "X-CSRF-TOKEN": getCookie("csrf_access_token"),
        // },
        data: JSON.stringify(field),
        success: function (response) {
          if (response.success) {
            layer.closeAll();
            table.reloadData('setting-group-table');
            layer.msg(response.message, { icon: 1 });
            $('#edit-setting-group-table-form')[0].reset();
          } else {
            layer.msg(response.message, { icon: 2 });
          }
        },
        error: function (xhr, status, error) {
          var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '请求失败';
          layer.msg('错误: ' + errorMessage, { icon: 2 });
        }
      });
      setTimeout(function () {
        layer.close(loadIndex); // 关闭加载弹层
      }, 3000);
      return false;
    });

    // 加组-离组 处理
    function group_opr(gid, obj, index) {
      if (index == 0) {
        $.ajax({
          url: '/api/v1/groups/join',
          type: 'PATCH',
          contentType: "application/json",
          // headers: {
          //   "X-CSRF-TOKEN": getCookie("csrf_access_token"),
          // },
          data: JSON.stringify([gid, obj]),
          success: function (response) {
            if (response.success) {
              layer.msg(response.message, { icon: 1 });
            } else {
              layer.msg(response.message, { icon: 2 });
            }
          },
          error: function (xhr, status, error) {
            var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '请求失败';
            layer.msg('错误: ' + errorMessage, { icon: 2 });
          }
        });
        return false;
      } else {
        $.ajax({
          url: '/api/v1/groups/leave',
          type: 'PATCH',
          contentType: "application/json",
          // headers: {
          //   "X-CSRF-TOKEN": getCookie("csrf_access_token"),
          // },
          data: JSON.stringify(obj),
          success: function (response) {
            if (response.success) {
              layer.msg(response.message, { icon: 1 });
            } else {
              layer.msg(response.message, { icon: 2 });
            }
          },
          error: function (xhr, status, error) {
            var errorMessage = xhr.responseJSON ? xhr.responseJSON.message : '请求失败';
            layer.msg('错误: ' + errorMessage, { icon: 2 });
          }
        });
        return false;
      }
    }

    // 请求穿梭框数据
    function getDataTransfer(data) {
      // var group_table_id = data.id
      $.ajax({
        url: '/api/v1/groups/transfer',
        method: 'GET',
        data: data,
        contentType: "application/json",
        success: function (response) {
          // layer.msg(response.message, { icon: 1 });
          var gid = response.data.gid;
          var data_left = response.data.col_left;
          var data_right = response.data.col_right;

          // 穿梭框渲染
          transfer.render({
            elem: '#group-transfer',
            id: 'group-transfer',
            data: data_left,
            // width: 
            title: ['网段', '已加入分组的网段'],
            height: 480,
            showSearch: true,
            value: data_right, //右侧列显示内容，按字典的value字段来
            parseData: function (data_left) { // 解析成规定的 data 格式
              return {
                "value": data_left.id, // 数据值
                "title": data_left.network, // 数据标题
                // "disabled": res.disabled,  // 是否禁用
                // "checked": res.checked // 是否选中
              };
            },
            onchange: function (obj, index) {
              // 调用加组离组函数
              group_opr(gid, obj, index)
            }
          });
        }
      });
    }

    // 穿梭框按钮点击
    table.on('tool(setting-group-table)', function (obj) {
      if (obj.event === 'details') {

        // 隐藏svg图形
        $('.setting-empty').hide()

        // 设置某行选中, 标注当前点击行的选中状态
        table.setRowChecked('setting-group-table', {
          type: 'radio',
          index: obj.data.id - 1, // 选中行的下标。 0 表示第一行
        });

        var data = obj.data; // 获取当前行数据
        getDataTransfer(data)

      }
    })
  })
</script>

</html>